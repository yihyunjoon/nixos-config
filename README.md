# nixos-config

Flake-based NixOS + Home Manager configuration.

Current outputs:

- `proxmox` (`x86_64-linux`)
- `orbstack` (`aarch64-linux`)

## Repository layout

```text
.
├── flake.nix
├── modules/
│   └── common.nix
├── machines/
│   ├── proxmox.nix
│   ├── proxmox-hardware.nix
│   ├── orbstack.nix
│   └── orbstack-guest.nix
└── users/
    └── <username>/
        ├── home.nix
        ├── proxmox.nix
        └── orbstack.nix
```

## Key files

- `flake.nix`
  - Defines `nixosConfigurations.proxmox`
  - Defines `nixosConfigurations.orbstack`
  - Connects Home Manager (`users/<username>/home.nix`)
- `modules/common.nix`
  - Shared system settings (timezone, locale, base packages, zsh, stateVersion)
- `machines/proxmox.nix`
  - Hostname: `nixos-proxmox`
  - SSH enabled
  - systemd-boot / EFI settings
- `machines/orbstack.nix`
  - Hostname: `nixos-orbstack`
  - Imports OrbStack guest module
  - Imports extra CA certs from OrbStack runtime
  - Detects and enforces the `orbstack` group GID from `/etc/group` (fail-fast)

## Apply configuration

### Proxmox

Run on the NixOS machine:

```bash
sudo nixos-rebuild switch --flake /path/to/nixos-config#proxmox
```

### OrbStack

Run on macOS host:

```bash
orb -m <vm-name> sudo nixos-rebuild switch --impure --flake <repo-path>#orbstack
```

Example:

```bash
REPO_PATH="$HOME/path/to/nixos-config"
VM_NAME="orbstack-nixos"
orb -m "$VM_NAME" sudo nixos-rebuild switch --impure --flake "$REPO_PATH"#orbstack
```

## Create a new OrbStack NixOS VM

```bash
VM_NAME="orbstack-nixos"
REPO_PATH="$HOME/path/to/nixos-config"
orb create nixos:unstable "$VM_NAME"
orb -m "$VM_NAME" sudo nixos-rebuild switch --impure --flake "$REPO_PATH"#orbstack
```

## OrbStack certificates and GID behavior

`machines/orbstack.nix` reads runtime data from:

- `/opt/orbstack-guest/run/extra-certs.crt` for additional trusted CAs
- `/etc/group` to detect the `orbstack` group GID

This is why `--impure` is required for OrbStack rebuilds.

Without `--impure`, evaluation intentionally fails with a clear error instead of silently using a wrong fallback value.

## Notes

- `machines/orbstack-guest.nix` is generated by OrbStack and may change after OrbStack updates.
- `machines/proxmox-hardware.nix` is generated by `nixos-generate-config`.
